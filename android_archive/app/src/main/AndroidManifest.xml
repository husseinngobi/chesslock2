<?xml version="1.0" encoding="utf-8"?>
<!-- ChessLock - Android 14 Compatible Lockscreen Replacement -->
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    android:installLocation="auto">

    <!-- Core lockscreen override permissions -->
    <uses-permission android:name="android.permission.SYSTEM_ALERT_WINDOW" />
    <uses-permission android:name="android.permission.DISABLE_KEYGUARD" />
    <uses-permission android:name="android.permission.WAKE_LOCK" />
    <uses-permission android:name="android.permission.RECEIVE_BOOT_COMPLETED" />
    <uses-permission android:name="android.permission.FOREGROUND_SERVICE" />
    <uses-permission android:name="android.permission.REQUEST_IGNORE_BATTERY_OPTIMIZATIONS" />
    
    <!-- Advanced lockscreen control (keeping only available to regular apps) -->
    <uses-permission android:name="android.permission.ACCESS_NOTIFICATION_POLICY" />
    
    <!-- Device admin permissions for secure locking -->
    <uses-permission android:name="android.permission.BIND_DEVICE_ADMIN" />
    
    <!-- Phone state detection for call handling -->
    <uses-permission android:name="android.permission.READ_PHONE_STATE" />
    
    <!-- Modern accessibility-based override (used by commercial lockscreen apps) -->
    <uses-permission android:name="android.permission.BIND_ACCESSIBILITY_SERVICE" />
    
    <!-- Additional permissions for aggressive override -->
    <uses-permission android:name="android.permission.KILL_BACKGROUND_PROCESSES" />
    <uses-permission android:name="android.permission.MODIFY_AUDIO_SETTINGS" />
    <!-- WRITE_SETTINGS removed - causes lint errors and not essential for Android 9 -->
    <uses-permission android:name="android.permission.CHANGE_CONFIGURATION" />
    
    <!-- System window manipulation (removed system-only permissions) -->
    
    <!-- Runtime permissions that may help with override -->
    <uses-permission android:name="android.permission.CAMERA" />
    <uses-permission android:name="android.permission.RECORD_AUDIO" />
    <uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION" />
    <uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" />
    
    <!-- Android 14+ Foreground Service requirements (Issues 7-8) -->
    <uses-permission android:name="android.permission.SCHEDULE_EXACT_ALARM" />
    <uses-permission android:name="android.permission.FOREGROUND_SERVICE_SYSTEM_EXEMPTED" />
    
    <!-- Hardware features -->
    <uses-feature android:name="android.hardware.camera" android:required="false" />
    <uses-feature android:name="android.hardware.microphone" android:required="false" />
    <uses-feature android:name="android.hardware.location" android:required="false" />

    <application
        android:allowBackup="true"
        android:dataExtractionRules="@xml/data_extraction_rules"
        android:fullBackupContent="@xml/backup_rules"
        android:icon="@mipmap/ic_launcher"
        android:label="@string/app_name"
        android:roundIcon="@mipmap/ic_launcher_round"
        android:supportsRtl="true"
        android:theme="@style/Theme.ChessLock"
        android:usesCleartextTraffic="false"
        android:requestLegacyExternalStorage="false"
        android:enableOnBackInvokedCallback="true">

        <!-- Core activities -->
        <activity
            android:name=".PreviewActivity"
            android:exported="false" />
            


        <activity
            android:name=".SettingsActivity"
            android:exported="false" />

        <activity
            android:name=".StatsActivity"
            android:exported="false" />

        <activity
            android:name=".LockScreenActivity"
            android:exported="false" />

        <!-- Debug activity for crash testing -->
        <activity
            android:name=".DebugLockActivity"
            android:exported="false" />

        <!-- Simple lockscreen activity as fallback -->
        <activity
            android:name=".SimpleLockActivity"
            android:exported="false" />

        <!-- Lockscreen replacement activity for Android 14 -->
        <activity
            android:name=".LockscreenReplacementActivity"
            android:exported="false"
            android:launchMode="singleTask"
            android:excludeFromRecents="true"
            android:theme="@android:style/Theme.Black.NoTitleBar.Fullscreen" />

        <activity
            android:name=".MainActivity"
            android:exported="true">
            <intent-filter>
                <action android:name="android.intent.action.MAIN" />
                <category android:name="android.intent.category.LAUNCHER" />
            </intent-filter>
            
            <!-- Assistant app intent filter for home button long-press -->
            <intent-filter>
                <action android:name="android.intent.action.ASSIST" />
                <category android:name="android.intent.category.DEFAULT" />
            </intent-filter>
            
            <!-- Voice interaction intent -->
            <intent-filter>
                <action android:name="android.service.voice.VoiceInteractionService" />
                <category android:name="android.intent.category.DEFAULT" />
            </intent-filter>
        </activity>

        <!-- Assistant Activity for home button long-press activation -->
        <activity
            android:name=".AssistantActivity"
            android:exported="true"
            android:theme="@android:style/Theme.Translucent.NoTitleBar"
            android:launchMode="singleTask"
            android:excludeFromRecents="true"
            android:noHistory="true">
            
            <!-- Primary assistant intent filter -->
            <intent-filter android:priority="100">
                <action android:name="android.intent.action.ASSIST" />
                <category android:name="android.intent.category.DEFAULT" />
            </intent-filter>
            
            <!-- Voice interaction intent -->
            <intent-filter android:priority="100">
                <action android:name="android.service.voice.VoiceInteractionService" />
                <category android:name="android.intent.category.DEFAULT" />
            </intent-filter>
            
            <!-- Custom ChessLock activation intents -->
            <intent-filter android:priority="100">
                <action android:name="com.ngobi.chesslock.ACTIVATE_LOCK" />
                <category android:name="android.intent.category.DEFAULT" />
            </intent-filter>
            
            <!-- Launcher gesture support -->
            <intent-filter android:priority="100">
                <action android:name="com.ngobi.chesslock.GESTURE_TAP" />
                <action android:name="com.ngobi.chesslock.GESTURE_DOUBLE_TAP" />
                <action android:name="com.ngobi.chesslock.GESTURE_LONG_PRESS" />
                <category android:name="android.intent.category.DEFAULT" />
            </intent-filter>
        </activity>

        <!-- Overlay lock activity -->
        <activity
            android:name=".OverlayLockActivity"
            android:exported="false"
            android:theme="@style/Theme.ChessLock.NoActionBar"
            android:launchMode="singleTask"
            android:excludeFromRecents="true"
            android:taskAffinity=""
            android:configChanges="orientation|screenSize|keyboardHidden|density|smallestScreenSize"
            android:showWhenLocked="true"
            android:turnScreenOn="true"
            android:lockTaskMode="if_whitelisted" />

        <activity android:name=".DonateActivity" android:exported="false" />

        <!-- Device admin receiver -->
        <receiver 
            android:name=".LockAdminReceiver"
            android:permission="android.permission.BIND_DEVICE_ADMIN"
            android:exported="true">
            <meta-data
                android:name="android.app.device_admin"
                android:resource="@xml/device_admin_receiver" />
            <intent-filter>
                <action android:name="android.app.action.DEVICE_ADMIN_ENABLED" />
            </intent-filter>
        </receiver>

        <!-- Wake receiver for intercepting screen wake/unlock -->
        <receiver android:name=".WakeReceiver"
            android:exported="true">
            <intent-filter android:priority="1000">
                <action android:name="android.intent.action.SCREEN_ON" />
                <action android:name="android.intent.action.USER_PRESENT" />
                <action android:name="android.intent.action.SCREEN_OFF" />
                <action android:name="android.intent.action.PHONE_STATE" />
                <action android:name="android.intent.action.NEW_OUTGOING_CALL" />
            </intent-filter>
        </receiver>

        <!-- Boot complete receiver for auto-activation after restart -->
        <receiver android:name=".BootCompleteReceiver"
            android:exported="true">
            <intent-filter android:priority="1000">
                <action android:name="android.intent.action.BOOT_COMPLETED" />
                <action android:name="android.intent.action.MY_PACKAGE_REPLACED" />
                <action android:name="android.intent.action.PACKAGE_REPLACED" />
                <data android:scheme="package" />
            </intent-filter>
        </receiver>

        <!-- Persistent foreground service for reliable lockscreen -->
        <service
            android:name=".ChessLockService"
            android:enabled="true"
            android:exported="false"
            android:foregroundServiceType="systemExempted" />

        <!-- Foreground lockscreen service for reliable overlay -->
        <service
            android:name=".LockScreenService"
            android:enabled="true"
            android:exported="false"
            android:foregroundServiceType="systemExempted"
            android:permission="android.permission.BIND_ACCESSIBILITY_SERVICE" />

        <!-- Accessibility service for Android 9+ lockscreen with fingerprint support -->
        <service
            android:name=".ChessLockAccessibilityService"
            android:exported="false"
            android:permission="android.permission.BIND_ACCESSIBILITY_SERVICE">
            <intent-filter>
                <action android:name="android.accessibilityservice.AccessibilityService" />
            </intent-filter>
            <meta-data
                android:name="android.accessibilityservice"
                android:resource="@xml/accessibility_service_config" />
        </service>

        <!-- App metadata for theming and configuration -->
        <meta-data
            android:name="com.ngobi.chesslock.theme"
            android:value="neo" />
        
        <meta-data
            android:name="com.ngobi.chesslock.version"
            android:value="1.0.0" />

    </application>

</manifest>